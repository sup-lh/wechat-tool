# 🎮 微信公众号智能管理工具

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org)
[![Flask](https://img.shields.io/badge/Flask-2.3.3-green.svg)](https://flask.palletsprojects.com)
[![License](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

呀~ 这是一个功能强大的微信公众号管理工具呢！(´∀｀) 支持AI图片生成、公众号配置管理、消息自动回复、草稿箱发布、一键发布等多种功能 💖

### 🌟 最新功能亮点
- **🎨 AI图片生成** - 集成图图API，输入描述即可生成4张精美AI分镜图片
- **🚀 一键发布** - 从AI图片生成到公众号发布，全流程自动化处理
- **📊 发布追踪** - 详细的发布统计和历史记录，实时监控成功率
- **🖼️ 智能处理** - 自动图片压缩、格式转换，完美适配微信API限制

## ✨ 功能特性

### 🔧 核心功能
- **🔗 公众号配置管理** - 支持多个公众号配置的绑定、验证和管理
- **📝 草稿箱发布** - 一键发布文章到微信公众号草稿箱，自动生成封面图片
- **🎨 AI图片生成与发布** - 集成图图API，生成AI图片并自动发布到公众号
- **🚀 草稿快速发布** - 支持草稿箱内容一键发布到公众号
- **🤖 智能消息服务器** - 实时接收和自动回复用户消息，支持多种消息类型
- **✅ URL验证服务** - 自动处理微信服务器的URL有效性验证
- **💾 本地配置存储** - 安全的本地配置文件管理，支持加密存储

### 🎯 高级功能
- **👑 管理员权限系统** - 支持管理员密码验证和权限管理
- **👤 用户隔离配置** - 每个用户可独立管理自己的公众号配置
- **📊 智能指令处理** - 通过微信消息执行CLI功能，如绑定、发布、查看配置等
- **🖼️ 智能图片处理** - 自动压缩、上传、转换图片格式，适配微信API限制
- **📈 发布结果追踪** - 完整的发布历史记录和详细统计信息
- **🔄 状态管理** - 智能的用户会话状态管理和超时处理
- **📱 多种消息支持** - 文本、图片、事件等多种消息类型的处理

### 🛡️ 安全特性
- **🔐 Token验证** - 严格的微信服务器签名验证
- **⏱️ 会话管理** - 自动过期的管理员会话和用户状态
- **🛡️ 防重复处理** - 智能的消息去重和防重复处理机制
- **📋 日志记录** - 完整的操作日志和错误追踪

## 📦 项目结构

```
wx_wechat_tool/
├── main.py                 # 主程序入口，CLI接口
├── config.py              # 配置管理模块
├── wechat_api.py          # 微信API封装
├── message_server.py      # 消息监听服务器
├── command_processor.py   # 指令处理器
├── tutu_api.py            # 图图API接口封装
├── work_storage.py        # 图图作品本地存储管理
├── requirements.txt       # 依赖包列表
├── deployment_guide.md    # 生产环境部署指南
├── start.sh              # 快速启动脚本
├── wx_config.json        # 配置文件（自动生成）
├── tutu_works.json       # 图图作品存储（自动生成）
└── wechat_messages.log   # 消息日志（自动生成）
```

## 🚀 快速开始

### 1. 环境准备

```bash
# 克隆项目
git clone <项目地址>
cd wx_wechat_tool

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
# macOS/Linux:
source venv/bin/activate
# Windows:
# venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

### 2. 基础使用

#### 绑定公众号配置
```bash
# 基础绑定（用于草稿箱发布）
python main.py bind -n "我的公众号" -a "你的AppID" -s "你的AppSecret"

# 完整绑定（包含消息服务器功能）
python main.py bind -n "我的公众号" -a "你的AppID" -s "你的AppSecret" -t "你的Token"
```

#### 发布文章到草稿箱
```bash
# 使用默认内容发布
python main.py publish -n "我的公众号"

# 自定义标题和内容
python main.py publish -n "我的公众号" -t "文章标题" -c "文章内容"
```

#### 启动消息监听服务器
```bash
# 本地测试（默认端口5000）
python main.py server -n "我的公众号"

# 生产环境（指定域名和端口）
python main.py server -n "我的公众号" -d "yourdomain.com" -p 443

# 开发测试（自定义端口）
python main.py server -n "我的公众号" -p 8080
```

### 3. 🎨 图图AI图片功能使用示例

通过微信消息，完整的AI图片生成到发布流程：

```
# 第一步：生成AI图片
发送消息：图图 美丽风景 春天的樱花盛开，阳光透过花瓣，温暖而美好

# 系统返回：
✅ 图片生成中...
🎨 标题: 美丽风景
📝 描述: 春天的樱花盛开，阳光透过花瓣，温暖而美好
🔢 生成数量: 4张
📋 任务ID: #e8bcd7eb6182101601067111e8d231a9

# 第二步：查询生成进度
发送消息：查询图图 e8bcd7eb6182101601067111e8d231a9

# 系统返回：
✅ 已经生成并绑定成功4张图片！
🆔 工作ID: #e8bcd7eb6182101601067111e8d231a9
🎨 作品标题: 美丽风景
📊 状态: 已完成并绑定

# 第三步：发布到公众号（方式一：创建草稿）
发送消息：发布图图 e8bcd7eb6182101601067111e8d231a9 我的公众号 春日樱花美景作品集 小编

# 第四步：快速发布草稿（方式二：一键发布）
发送消息：发布图图 e8bcd7eb6182101601067111e8d231a9 我的公众号 春日樱花美景作品集 小编 立即发布

# 第五步：查看发布结果
发送消息：查询发布结果 e8bcd7eb6182101601067111e8d231a9
```

## 📚 详细使用指南

### CLI命令参考

#### `bind` - 绑定公众号配置
```bash
python main.py bind [OPTIONS]

选项:
  -n, --name TEXT    配置名称 [必需]
  -a, --appid TEXT   公众号AppID [必需]
  -s, --secret TEXT  公众号AppSecret [必需]
  -t, --token TEXT   消息服务器Token [可选]
```

#### `publish` - 发布文章
```bash
python main.py publish [OPTIONS]

选项:
  -n, --name TEXT     使用的配置名称 [必需]
  -t, --title TEXT    文章标题 [默认: "测试文章"]
  -c, --content TEXT  文章内容 [默认: 自动生成测试内容]
```

#### `server` - 启动消息服务器
```bash
python main.py server [OPTIONS]

选项:
  -n, --name TEXT    使用的配置名称 [必需]
  -p, --port INTEGER 服务器端口 [默认: 443]
  -h, --host TEXT    服务器地址 [默认: 0.0.0.0]
  -d, --domain TEXT  外网访问域名 [默认: your-domain.com]
```

#### `list` - 查看配置列表
```bash
python main.py list
```

#### `test` - 测试配置连接
```bash
python main.py test -n "配置名称"
```

#### `delete` - 删除配置
```bash
python main.py delete -n "配置名称"
```

### 🤖 微信消息指令

通过微信消息可以直接执行管理功能：

#### 管理员指令
```
# 获取管理员权限
admin <密码>

# 绑定新的公众号配置
bind <配置名称> <AppID> <AppSecret>

# 发布文章到草稿箱
publish <配置名称> <标题> <内容>

# 查看所有配置
list

# 测试配置连接
test <配置名称>

# 删除配置
delete <配置名称>
```

#### 用户指令

##### 基础功能
```
# 绑定个人公众号配置
绑定 <AppID> <AppSecret> <昵称>

# 发布个人文章
使用 <昵称> 发布 <标题> <内容> [作者]

# 查看个人配置
我的配置

# 测试配置连接
测试 <昵称>
```

##### 🎨 图图AI图片功能
```
# 生成AI图片（4张分镜）
图图 <标题> <描述>

# 查询图片生成进度
查询图图 <工作ID>

# 发布图片作品集到草稿箱
发布图图 <工作ID> <昵称> <标题> [作者]

# 发布图片作品集并立即发布
发布图图 <工作ID> <昵称> <标题> [作者] 立即发布

# 查看发布结果和统计
查询发布结果 <工作ID>
```

##### 🚀 草稿发布功能
```
# 快速发布草稿箱内容
发布草稿 <昵称> <media_id>
```

#### 通用回复
```
你好/hello    - 问候回复
帮助/help     - 功能说明
时间/time     - 当前时间
发送图片      - 图片确认回复
关注公众号    - 欢迎消息
```

## 🔧 配置说明

### 配置文件格式
```json
{
  "公众号名称": {
    "appid": "wx1234567890",
    "secret": "abcdef1234567890",
    "token": "your_token"
  },
  "user_configs": {
    "用户ID": {
      "配置名称": {
        "appid": "wx1234567890",
        "secret": "abcdef1234567890"
      }
    }
  }
}
```

### 微信公众平台配置

在微信公众平台「开发 - 基本配置 - 服务器配置」中设置：

- **URL**: `https://yourdomain.com/wechat`
- **Token**: 与绑定时设置的Token一致
- **EncodingAESKey**: 微信自动生成或手动设置
- **消息加解密方式**: 建议选择"安全模式"

## 🛠️ 部署指南

### 开发环境
```bash
# 本地开发测试
python main.py server -n "测试公众号" -p 8080

# 使用内网穿透工具（如ngrok）
ngrok http 8080
```

### 生产环境

详细的生产环境部署指南请参考 [deployment_guide.md](deployment_guide.md)，包含：

- 🔒 HTTPS + Nginx 反向代理配置
- 🐳 Docker 容器化部署
- 🔄 Systemd 服务管理
- 🛡️ 安全配置建议
- 📊 监控和日志管理

### 快速部署脚本
```bash
# 使用提供的启动脚本
chmod +x start.sh
./start.sh
```

## 🎯 API功能详解

### 🎨 图图AI图片生成流程
1. **调用图图API** - 使用标题和描述生成4张AI分镜图片
2. **进度监控** - 实时查询图片生成进度和状态
3. **自动绑定** - 生成完成后自动保存到本地存储
4. **图片处理** - 下载图片并自动压缩适配微信限制
5. **批量上传** - 将图片上传到微信永久素材库
6. **内容创建** - 生成精简的纯图片HTML内容
7. **草稿创建** - 创建包含所有图片的草稿箱文章
8. **可选发布** - 支持立即发布到公众号

### 🚀 草稿发布流程
1. **获取AccessToken** - 使用AppID和AppSecret获取访问令牌
2. **调用发布API** - 使用微信freepublish接口发布草稿
3. **任务提交** - 获取发布任务ID和消息ID
4. **状态追踪** - 记录发布状态和结果详情
5. **结果通知** - 提供详细的发布状态和处理结果

### 草稿箱发布流程
1. **获取AccessToken** - 使用AppID和AppSecret获取访问令牌
2. **生成封面图片** - 自动创建带标题的封面图片
3. **上传素材** - 将封面图片上传到微信素材库
4. **创建草稿** - 使用素材ID创建图文消息草稿
5. **返回结果** - 提供草稿箱链接和操作结果

### 消息处理流程
1. **签名验证** - 验证微信服务器发送的签名
2. **消息解析** - 解析XML格式的消息内容
3. **指令识别** - 识别用户消息中的指令类型
4. **权限检查** - 验证用户权限和管理员状态
5. **功能执行** - 执行对应的功能并返回结果
6. **响应生成** - 生成XML格式的响应消息

## 🐛 故障排除

### 常见问题

#### 绑定失败
- ✅ 检查AppID和AppSecret是否正确
- ✅ 确认公众号类型支持相关接口
- ✅ 检查网络连接和防火墙设置

#### 图图生成失败
- ✅ 检查图图API网络连接
- ✅ 确认工作ID格式是否正确
- ✅ 验证图片是否全部生成完成
- ✅ 检查图片下载和压缩是否成功

#### 发布失败
- ✅ 验证公众号是否有草稿箱权限
- ✅ 检查AccessToken是否过期
- ✅ 确认素材上传是否成功
- ✅ 验证图片大小是否超过1MB限制

#### 草稿发布失败
- ✅ 检查草稿media_id是否有效
- ✅ 确认公众号具有发布权限
- ✅ 验证草稿是否通过审核检查
- ✅ 确认API调用频率限制

#### URL验证失败
- ✅ 检查Token配置是否与微信公众平台一致
- ✅ 确认服务器端口和防火墙设置
- ✅ 验证域名DNS解析是否正确
- ✅ 检查HTTPS证书配置

#### 消息接收异常
- ✅ 查看服务器日志：`tail -f wechat_messages.log`
- ✅ 检查Nginx代理配置
- ✅ 验证微信服务器IP白名单设置

### 日志分析
```bash
# 实时查看消息日志
tail -f wechat_messages.log

# 查看系统服务日志
sudo journalctl -u wechat-bot -f

# 检查Nginx访问日志
sudo tail -f /var/log/nginx/access.log
```

## 🔒 安全注意事项

1. **敏感信息保护**
   - AppSecret和Token请妥善保管，避免泄露
   - 不要在公开代码中硬编码敏感信息
   - 建议使用环境变量存储敏感配置

2. **服务器安全**
   - 使用HTTPS协议保护数据传输
   - 配置防火墙，只开放必要端口
   - 定期更新系统和依赖包

3. **访问控制**
   - 修改默认管理员密码
   - 定期清理过期的用户会话
   - 限制用户配置数量和操作频率

## 📋 系统要求

- **Python**: 3.8+
- **操作系统**: Linux / macOS / Windows
- **内存**: 最小 256MB，推荐 512MB+
- **磁盘**: 最小 100MB 可用空间
- **网络**: 需要访问微信API服务器

## 📦 依赖包说明

```
requests==2.31.0   # HTTP请求库，用于调用微信API
Pillow==10.0.0     # 图像处理库，用于生成封面图片
click==8.1.7       # CLI框架，提供命令行接口
colorama==0.4.6    # 终端颜色输出，美化CLI显示
Flask==2.3.3       # Web框架，提供消息服务器功能
```

## 🤝 贡献指南

1. Fork 本项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开 Pull Request

## 📄 许可证

本项目采用 MIT 许可证 - 详情请参阅 [LICENSE](LICENSE) 文件

## 🙏 致谢

感谢微信公众平台提供的API支持，以及所有开源依赖包的开发者们！

## 📞 支持与反馈

如果您在使用过程中遇到问题或有改进建议，欢迎：

- 🐛 提交 Issue 报告问题
- 💡 提交 Feature Request 建议新功能
- 📧 通过邮件联系维护者
- 📱 在微信公众号中直接反馈

---

嘿嘿~ 希望这个工具能帮助你更好地管理微信公众号呢！(´∀｀) 使用愉快！💖✨